<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Course Playlist - LearniX</title>

   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
   <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="header">
   <section class="flex">
      <a href="home.html" class="logo">LearniX</a>
      <form action="courses.html" method="get" class="search-form">
         <input type="text" name="search" required placeholder="search courses..." maxlength="100">
         <button type="submit" class="fas fa-search"></button>
      </form>
      <div class="icons">
         <div id="menu-btn" class="fas fa-bars"></div>
         <div id="search-btn" class="fas fa-search"></div>
         <div id="user-btn" class="fas fa-user"></div>
         <div id="toggle-btn" class="fas fa-sun"></div>
      </div>
      <div class="profile">
         <img src="images/pic-1.jpg" class="image" alt="">
         <h3 class="name">Guest</h3>
         <p class="role">Student</p>
         <a href="profile.html" class="btn">view profile</a>
      </div>
   </section>
</header>   

<div class="side-bar">
   <div id="close-btn"><i class="fas fa-times"></i></div>
   <div class="profile">
      <img src="images/pic-1.jpg" class="image" alt="">
      <h3 class="name">Guest</h3>
      <p class="role">Student</p>
      <a href="profile.html" class="btn">view profile</a>
   </div>
   <nav class="navbar">
      <a href="home.html"><i class="fas fa-home"></i><span>home</span></a>
      <a href="dashboard.html"><i class="fas fa-chart-line"></i><span>dashboard</span></a>
      <a href="courses.html"><i class="fas fa-graduation-cap"></i><span>courses</span></a>
      <a href="teachers.html"><i class="fas fa-chalkboard-user"></i><span>teachers</span></a>
      <a href="forum.html"><i class="fas fa-comments"></i><span>forum</span></a>
      <a href="contact.html"><i class="fas fa-headset"></i><span>contact us</span></a>
   </nav>
</div>

<section class="playlist-details">
   <h1 class="heading">Course Details</h1>
   <div class="row">
      <div class="column">
         <div class="thumb">
            <img id="courseImg" src="images/thumb-1.png" alt="">
            <span id="courseVideosCount">0 videos</span>
         </div>
      </div>
      <div class="column">
         <div class="tutor">
            <img id="tutorImg" src="images/pic-2.jpg" alt="">
            <div>
               <h3 id="tutorName">Teacher Name</h3>
               <span id="tutorEmail">teacher@example.com</span>
            </div>
         </div>
         <div class="details">
            <h3 id="courseTitle">Course Title</h3>
            <p id="courseDesc">Description...</p>
            <a href="#" id="tutorProfileLink" class="inline-btn">View Teacher Profile</a>
         </div>
      </div>
   </div>
</section>

<section class="playlist-videos">
   <h1 class="heading">Playlist Videos</h1>
   <div class="box-container" id="videoContainer">
       </div>
</section>

<section class="course-quizzes" style="margin-top: 3rem;">
   <h1 class="heading">Course Quizzes</h1>
   <div class="box-container" id="quiz-container">
       <p class="empty">Checking for quizzes...</p>
   </div>
</section>

<footer class="footer">
   &copy; copyright @ 2026 by <span>LearniX</span> | all rights reserved!
</footer>

<script src="js/script.js"></script>
<script>
   // âš ï¸ IMPORTANT : Votre URL Tunnel
   const API_BASE = 'https://wv7pc13r-5000.euw.devtunnels.ms'; 

   document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const courseId = urlParams.get('id');

      if (!courseId) {
         document.querySelector('.playlist-details').innerHTML = '<p class="empty">No course specified.</p>';
         return;
      }

      // 1. Charger les infos du cours
      try {
         const res = await fetch(`${API_BASE}/api/cours/${courseId}`);
         if (!res.ok) throw new Error("Course not found");
         const course = await res.json();

         // Mise Ã  jour de l'interface (SÃ©curisÃ©e avec des 'if')
         const cImg = document.getElementById('courseImg');
         if(cImg) cImg.src = course.image ? (course.image.startsWith('http') ? course.image : `${API_BASE}/${course.image}`) : 'images/thumb-1.png';
         
         const cTitle = document.getElementById('courseTitle');
         if(cTitle) cTitle.textContent = course.titre;

         const cDesc = document.getElementById('courseDesc');
         if(cDesc) cDesc.textContent = course.description;
         
         const vCount = document.getElementById('courseVideosCount');
         if(vCount) vCount.textContent = (course.contenu ? course.contenu.length : 0) + ' videos';

         // Infos du Prof
         if (course.enseignant) {
             const t = course.enseignant;
             const tImg = document.getElementById('tutorImg');
             if(tImg) tImg.src = t.image ? (t.image.startsWith('http') ? t.image : `${API_BASE}/${t.image}`) : 'images/pic-2.jpg';
             
             const tName = document.getElementById('tutorName');
             if(tName) tName.textContent = `${t.prenom || ''} ${t.nom || ''}`;
             
             const tEmail = document.getElementById('tutorEmail');
             if(tEmail) tEmail.textContent = t.email;

             const tLink = document.getElementById('tutorProfileLink');
             if(tLink) tLink.href = `teacher_profile.html?id=${t._id || t}`;
         }

         // 2. Charger les VidÃ©os
         const videoContainer = document.getElementById('videoContainer');
         if(videoContainer) {
             videoContainer.innerHTML = '';
             if (course.contenu && course.contenu.length > 0) {
                 course.contenu.forEach(video => {
                     const vidUrl = video.url.startsWith('http') ? video.url : `${API_BASE}/${video.url}`;
                     const box = document.createElement('div');
                     box.className = 'box';
                     box.innerHTML = `
                        <i class="fas fa-play"></i>
                        <img src="${cImg ? cImg.src : 'images/thumb-1.png'}" alt="">
                        <h3>${video.titre}</h3>
                        <a href="${vidUrl}" target="_blank" class="inline-btn">Watch Video</a>
                     `;
                     videoContainer.appendChild(box);
                 });
             } else {
                 videoContainer.innerHTML = '<p class="empty">No videos uploaded yet.</p>';
             }
         }

         // 3. Charger les Quiz
         await loadQuizzesForCourse(courseId);

      } catch (err) {
         console.error(err);
         // Ne pas Ã©craser toute la page si juste une erreur d'image
         // document.querySelector('.playlist-details').innerHTML = '<p class="empty">Error loading course.</p>';
      }
   });

   // ðŸ”¥ FONCTION CHARGEMENT QUIZ
   async function loadQuizzesForCourse(courseId) {
       const quizContainer = document.getElementById('quiz-container');
       if (!quizContainer) return;

       quizContainer.innerHTML = '<p class="empty">Loading quizzes...</p>';

       try {
           const token = localStorage.getItem('token');
           const res = await fetch(`${API_BASE}/api/quizzes/${courseId}`, {
               headers: { 'Authorization': `Bearer ${token}` }
           });
           
           if (!res.ok) {
               quizContainer.innerHTML = '<p class="empty">No quizzes found.</p>';
               return;
           }

           const quizzes = await res.json();
           quizContainer.innerHTML = ''; 

           if (!Array.isArray(quizzes) || quizzes.length === 0) {
               quizContainer.innerHTML = '<p class="empty">No quizzes available for this course.</p>';
               return;
           }

           quizzes.forEach(quiz => {
               const box = document.createElement('div');
               box.className = 'box';
               box.style.border = 'var(--border)';
               box.style.padding = '2rem';
               box.style.marginTop = '1rem';
               box.style.backgroundColor = 'var(--white)';
               
               box.innerHTML = `
                   <h3 class="title" style="font-size: 1.8rem; margin-bottom: 1rem;">${quiz.titre}</h3>
                   <p style="font-size: 1.4rem; color: var(--light-color); margin-bottom: 1.5rem;">${quiz.questions.length} Questions</p>
                   <a href="take_quiz.html?id=${quiz._id}" class="inline-btn">Start Quiz</a>
               `;
               quizContainer.appendChild(box);
           });

       } catch (error) {
           console.error("Error loading quizzes:", error);
           quizContainer.innerHTML = '<p class="empty">Failed to load quizzes.</p>';
       }
   }
</script>

</body>
</html>