<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Watch Video</title>

   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
   <link rel="stylesheet" href="css/style.css">

</head>

<body>

   <header class="header">
      <section class="flex">
         <a href="home.html" class="logo">LearniX</a>
         <form action="courses.html" method="get" class="search-form">
            <input type="text" name="search" required placeholder="search courses..." maxlength="100">
            <button type="submit" class="fas fa-search"></button>
         </form>
         <div class="icons">
            <div id="menu-btn" class="fas fa-bars"></div>
            <div id="search-btn" class="fas fa-search"></div>
            <div id="user-btn" class="fas fa-user"></div>
            <div id="toggle-btn" class="fas fa-sun"></div>
         </div>
         <div class="profile">
            <img src="images/pic-1.jpg" class="image" alt="">
            <h3 class="name">Guest</h3>
            <p class="role">Student</p>
            <a href="profile.html" class="btn">view profile</a>
            <div class="flex-btn">
               <a href="login.html" class="option-btn">login</a>
               <a href="register.html" class="option-btn">register</a>
            </div>
         </div>
      </section>
   </header>

   <div class="side-bar">
      <div id="close-btn">
         <i class="fas fa-times"></i>
      </div>
      <div class="profile">
         <img src="images/pic-1.jpg" class="image" alt="">
         <h3 class="name">Guest</h3>
         <p class="role">Student</p>
         <a href="profile.html" class="btn">view profile</a>
      </div>
      <nav class="navbar">
         <a href="home.html"><i class="fas fa-home"></i><span>home</span></a>
         <a href="dashboard.html"><i class="fas fa-chart-line"></i><span>dashboard</span></a>
         <a href="about.html"><i class="fas fa-question"></i><span>about</span></a>
         <a href="courses.html"><i class="fas fa-graduation-cap"></i><span>courses</span></a>
         <a href="teachers.html"><i class="fas fa-chalkboard-user"></i><span>teachers</span></a>
         <a href="inbox.html"><i class="fas fa-envelope"></i><span>messages</span></a>
         <a href="contact.html"><i class="fas fa-headset"></i><span>contact us</span></a>
      </nav>
   </div>

   <section class="watch-video">

      <div class="video-container">
         <div class="video">
            <video id="video-player" controls poster="images/post-1-1.png">
               <source src="" type="video/mp4">
               Your browser does not support the video tag.
            </video>
         </div>
         <h3 class="title" id="videoTitle">Loading...</h3>
         <div class="info">
            <p class="date"><i class="fas fa-calendar"></i><span id="videoDate">...</span></p>
            <p class="date"><i class="fas fa-heart"></i><span id="videoLikes">0 likes</span></p>
         </div>
         <div class="tutor">
            <img src="images/pic-2.jpg" alt="" id="tutorImage">
            <div>
               <h3 id="tutorName">...</h3>
               <span id="tutorRole">...</span>
            </div>
         </div>
         <form action="" method="post" class="flex">
            <a href="#" id="backToPlaylist" class="inline-btn">view playlist</a>
            <button type="button" id="likeBtn"><i class="far fa-heart"></i><span>like</span></button>
         </form>
         <p class="description" id="videoDescription">
            Loading video description...
         </p>
      </div>

   </section>

  <script src="js/script.js"></script>
  
  <script>
      
      const API_BASE = 'https://wv7pc13r-5000.euw.devtunnels.ms'; 
 

      document.addEventListener('DOMContentLoaded', async () => {
         const urlParams = new URLSearchParams(window.location.search);
         const courseId = urlParams.get('id');
         const videoIndex = urlParams.get('vid');
         const user = getCurrentUser(); // from script.js

         // 1. Vérification des paramètres
         if (!courseId || videoIndex === null) {
            showToast("Lien invalide", "error");
            setTimeout(() => window.location.href = 'courses.html', 2000);
            return;
         }

         try {
            // 2. Récupérer le cours complet
            const res = await fetch(`${API_BASE}/api/cours/${courseId}`);
            if (!res.ok) throw new Error("Erreur chargement cours");
            
            const course = await res.json();

            // 3. Trouver la bonne vidéo dans le tableau 'contenu'
            const video = course.contenu ? course.contenu[videoIndex] : null;

            if (!video) {
               showToast("Vidéo introuvable", "error");
               return;
            }

            // 4. Mettre à jour le lecteur 
            const videoPlayer = document.getElementById('video-player');
            const videoSource = video.videoUrl; 

            if (videoSource) {
               // Gestion YouTube
               if (videoSource.includes('youtube.com') || videoSource.includes('youtu.be')) {
                  const embedUrl = videoSource.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
                  videoPlayer.parentElement.innerHTML = `<iframe width="100%" height="500" src="${embedUrl}" frameborder="0" allowfullscreen style="border-radius: .5rem;"></iframe>`;
               } 
               // Gestion Vidéo Locale (Uploadée via Multer)
               else {
                  // On s'assure que l'URL est propre
                  videoPlayer.src = `${API_BASE}/${videoSource}`;
                  videoPlayer.load(); // Important pour recharger la source
               }
            }

            // 5. Mettre à jour les infos
            document.getElementById('videoTitle').textContent = video.titre || 'Vidéo sans titre';
            
            // Description : Fallback sur la description du cours si la vidéo n'en a pas
            document.getElementById('videoDescription').textContent = video.description || course.description || 'Pas de description.';
            
            document.getElementById('videoDate').textContent = new Date(course.createdAt).toLocaleDateString();

            // 6. Infos Enseignant
            if (course.enseignant) {
               const teacherName = course.enseignant.nom + ' ' + (course.enseignant.prenom || '');
               document.getElementById('tutorName').textContent = teacherName;
               document.getElementById('tutorRole').textContent = 'Enseignant'; // Ou course.enseignant.role
               if (course.enseignant.image) {
                  // Gestion de l'image prof (lien complet ou relatif)
                  const imgPath = course.enseignant.image.startsWith('http') 
                     ? course.enseignant.image 
                     : `${API_BASE}/${course.enseignant.image}`;
                  document.getElementById('tutorImage').src = imgPath;
               }
            }

            // 7. Bouton retour
            document.getElementById('backToPlaylist').href = `playlist.html?id=${courseId}`;

            // 8. Bouton Like (Visuel uniquement pour l'instant)
            const likeBtn = document.getElementById('likeBtn');
            likeBtn.onclick = () => {
               if (!user) {
                  showToast("Connectez-vous pour aimer", "warning");
                  return;
               }
               const icon = likeBtn.querySelector('i');
               icon.classList.toggle('far');
               icon.classList.toggle('fas');
               
               // Animation petit cœur
               if(icon.classList.contains('fas')) {
                  showToast("Ajouté aux favoris ! ❤️", "success");
               }
            };

         } catch (err) {
            console.error(err);
            showToast("Erreur lors du chargement de la vidéo", "error");
         }
      });
   </script>
</body>

</html>